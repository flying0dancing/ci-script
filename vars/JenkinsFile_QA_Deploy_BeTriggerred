#!groovy
@Library('pipeline-libs') _

stage('setup'){
    node{
        loadLocalSteps()
    }
}
private void loadLocalSteps(){
    library identifier: 'ci-script@sshTest',
            retriever: modernSCM([
                    $class: 'GitSCMSource',
                    credentialsId: '46afdff1-cdd3-4098-b8af-d904b4d298aa',
                    id: 'a58b1061-f557-46f6-ba36-b53cfdb77d43',
                    remote: 'ssh://git@bitbucket.lombardrisk.com:7999/cprod/ci-script.git',
                    traits: [[$class: 'BranchDiscoveryTrait']]])
}
def propsSet
pipeline{
    //agent { label 'PRODUCT-CI-SHA-LOCAL1' }
    agent { label 'PRODUCT-CI-TEST' }
    options { skipDefaultCheckout true }
    parameters {

        string name: 'REPO_NAME',
                description: 'repo name in bitbucket'

        string name: 'REPO_BRANCH',
                description: 'repo branch in bitbucket',
                defaultValue: 'feature/ci'

        string name: 'PROJECT_FOLDER',
                description: 'any name like hkma, mas, ...'

        string name: 'DEPLOY_FOLDER',
                description: 'Deploy folder contains env.properties and deployment.json'



    }
    stages{
        stage('checkout') {
            steps {
                script {
                    shallowCheckout('sshTest')
                    testSourceCheckout(params.PROJECT_FOLDER,params.REPO_NAME,params.REPO_BRANCH)
                }
            }
        }
        stage("deploy installers"){
            steps{
                script{
                    propsSet=readProperty.get(params.PROJECT_FOLDER,params.DEPLOY_FOLDER)
                    installersJson(params.PROJECT_FOLDER,params.DEPLOY_FOLDER)
                }
            }
        }
    }
    post {
        always {
            email(propsSet)
        }
    }
}

