#!groovy
@Library('pipeline-libs') _

stage('setup'){
    node{
        loadLocalSteps('ci-script','sshTest')
    }
}

def propsSet
pipeline{
    //agent { label 'PRODUCT-CI-SHA-LOCAL1' }
    agent { label 'PRODUCT-CI-TEST' }
    options { skipDefaultCheckout true }
    parameters {

        string name: 'REPO_NAME',
                description: 'repo name in bitbucket'

        string name: 'REPO_BRANCH',
                description: 'repo branch in bitbucket',
                defaultValue: 'feature/ci'

        string name: 'PROJECT_FOLDER',
                description: 'any name like hkma, mas, ...'

        string name: 'DEPLOY_FOLDER',
                description: 'Deploy folder contains env.properties and deployment.json'



    }
    stages{
        stage('checkout') {
            steps {
                script {
                    shallowCheckout('ci-script','sshTest')
                    testSourceCheckout(params.PROJECT_FOLDER,params.REPO_NAME,params.REPO_BRANCH)
                }
            }
        }
        stage("deploy installers"){
            steps{
                script{
                    propsSet=readProperty.get(params.PROJECT_FOLDER,params.DEPLOY_FOLDER)
                    installersJson(params.PROJECT_FOLDER,params.DEPLOY_FOLDER)
                }
            }
        }
    }
    post {
        always {
            echo "this is always run"
            officeConnector(propsSet)
        }
    }
}

