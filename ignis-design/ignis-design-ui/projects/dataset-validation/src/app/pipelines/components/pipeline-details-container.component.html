<dv-sidenav
  [sidenavOpened]="sidenavOpened"
  [mode]="'side'"
  [disableClose]="true"
>
  <div primary-content>
    <dv-product-breadcrumb
      *ngIf="!!(product$ | async) && !!(pipeline$ | async)"
      [productId]="productId"
      [productName]="productName"
      [pipelineName]="pipelineName"
      [breadcrumbLevel]="'PIPELINE'"
    >
    </dv-product-breadcrumb>

    <div *ngIf="pipeline$ | async">
      <h1 class="mat-h1 flex-inline flex-align-center">
        <dv-inline-edit
          [required]="true"
          type="text"
          width="500px"
          [initialValue]="pipelineName"
          [editFunction]="editPipelineName"
        >
        </dv-inline-edit>
      </h1>

      <div>
        <div class="flex-row-spaced-between">
          <div>
            <h2 class="mat-h2 flex-inline flex-align-center">
              <mat-icon class="margin-right-1">share</mat-icon>
              Pipeline Graph View
            </h2>
          </div>
          <div>
            <dv-pipeline-step-tests-status-button-container></dv-pipeline-step-tests-status-button-container>
          </div>
        </div>

        <mat-card
          *ngIf="pipelineError && pipelineError.errors.length > 0"
          class="errors-container"
        >
          <h4
            mat-h4
            *ngFor="let error of pipelineError.errors"
            class="flex-inline flex-align-center"
          >
            <mat-icon style="margin-right: 6px;">error</mat-icon>
            {{ error.errorMessage }}
          </h4>
          <mat-slide-toggle
            *ngIf="pipelineError.graphNotConnected"
            [checked]="false"
            (change)="showDisconnectedSetsChange($event)"
          >
            Show disconnected sets
          </mat-slide-toggle>
        </mat-card>

        <mat-card *ngIf="pipelineDisplayError" class="errors-container">
          <h4 mat-h4 class="flex-inline flex-align-center">
            <mat-icon style="margin-right: 6px;">error</mat-icon>
            {{ pipelineDisplayError.errorMessage }}
          </h4>
          <div
            *ngIf="pipelineDisplayError.cyclicalStep"
            class="cyclical-step-container"
          >
            View erroneous step
            <a (click)="editStep({ id: pipelineDisplayError.cyclicalStep.id })">
              "{{ pipelineDisplayError.cyclicalStep.name }}"
            </a>
          </div>
        </mat-card>
        <div class="dag-container flex-center" *ngIf="!pipelineDisplayError">
          <dv-dag
            (mousewheel)="mousewheel($event)"
            [inputEdges]="pipelineEdges"
            [nodeContextMap]="schemaNodeContext"
            [edgeContextMap]="edgeContextMap"
            [zoom]="dagZoom"
            [width]="600"
            [height]="200"
            [colorMapOverride]="
              showDisconnectedSets ? dagColorMapOverride : null
            "
          ></dv-dag>
        </div>

        <div class="flex-center" *ngIf="!pipelineDisplayError">
          <mat-slider
            [min]="minDagZoom"
            [max]="maxDagZoom"
            step="0.5"
            [value]="dagZoom"
            (change)="dagEventService.zoomEvent.emit($event.value)"
          ></mat-slider>
        </div>
      </div>

      <div class="flex-row-spaced-between flex-align-center">
        <h2 class="mat-h2 flex-inline flex-align-center">
          <mat-icon class="margin-right-1">clear_all</mat-icon>
          Steps
        </h2>
        <dv-add-fab-button
          title="Add Step"
          class="e2e-add-pipeline-step-button"
          (add)="addStep()">
        </dv-add-fab-button>
      </div>

      <dv-pipeline-steps-grid
        [pipelineId]="pipelineId"
        [pipelineSteps]="steps"
        [loading]="loading$ | async"
        [productId]="productId"
        [schemas]="schemas"
      ></dv-pipeline-steps-grid>
    </div>
  </div>

  <div side-content>
    <dv-step-root-form
      #pipelineStepForm
      [loading]="stepFormLoading$ | async"
      [loaded]="stepFormLoaded$ | async"
      [schemas]="schemas"
      [apiErrors]="errors$ | async"
      (dataOutput)="saveStep($event)"
      (closeSidenavOutput)="closeSidenav()"
    ></dv-step-root-form>
  </div>
</dv-sidenav>
