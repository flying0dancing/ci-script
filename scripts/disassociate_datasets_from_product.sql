DELETE FROM PIPELINE_STEP_INVC_DATASET PID WHERE PID.PIPELINE_STEP_INVOCATION_ID IN
  (SELECT PSI.ID FROM PIPELINE_STEP_INVOCATION PSI
    JOIN PIPELINE_STEP PS ON PSI.PIPELINE_STEP_ID = PS.ID
    JOIN PIPELINE P ON PS.PIPELINE_ID = P.ID
    JOIN PRODUCT_CONFIG PC on P.PRODUCT_ID = PC.ID
    WHERE PC.NAME = :productName
    );

DELETE FROM PIPELINE_STEP_INVOCATION PI WHERE PI.ID IN
  (SELECT PSI.ID FROM PIPELINE_STEP_INVOCATION PSI
    JOIN PIPELINE_STEP PS ON PSI.PIPELINE_STEP_ID = PS.ID
    JOIN PIPELINE P ON PS.PIPELINE_ID = P.ID
    JOIN PRODUCT_CONFIG PC on P.PRODUCT_ID = PC.ID
    WHERE PC.NAME = :productName
    );

DELETE FROM PIPELINE_INVOCATION PI WHERE PI.ID IN
  (SELECT PI.ID FROM PIPELINE_INVOCATION PI
    JOIN PIPELINE P ON PI.PIPELINE_ID = P.ID
    JOIN PRODUCT_CONFIG PC on P.PRODUCT_ID = PC.ID
    WHERE PC.NAME = :productName
    );

DELETE FROM VALIDATION_RESULTS_SUMMARY VS
WHERE VS.DATASET_ID IN
  (select D.ID from DATASET D
      JOIN DATASET_SCHEMA DS ON D.DATASET_SCHEMA_ID = DS.ID
      JOIN PRODUCT_CONFIG P ON P.ID = DS.PRODUCT_ID
      WHERE P.NAME = :productName);

DELETE FROM VALIDATION_RULE V
WHERE V.DATASET_SCHEMA_ID IN
  (select DS.ID FROM DATASET_SCHEMA DS
      JOIN PRODUCT_CONFIG P ON P.ID = DS.PRODUCT_ID
      WHERE P.NAME = :productName);

UPDATE DATASET
SET DATASET_SCHEMA_ID = NULL
WHERE DATASET_SCHEMA_ID IN (SELECT sch.id
                            FROM DATASET_SCHEMA sch
                            join PRODUCT_CONFIG pc on sch.PRODUCT_ID = pc.ID
                            WHERE pc.NAME = :productName);


UPDATE DATASET_SCHEMA
SET HAS_DATASETS = NULL
WHERE ID IN (SELECT sch.id
             FROM DATASET_SCHEMA sch
             join PRODUCT_CONFIG pc on sch.PRODUCT_ID = pc.ID
             WHERE pc.NAME = :productName);
