ALTER TABLE DATASET
  ADD PIPELINE_STEP_INVOCATION_ID BIGINT;

ALTER TABLE DATASET
  ADD CONSTRAINT DATASET_PI_FK FOREIGN KEY (PIPELINE_INVOCATION_ID) REFERENCES PIPELINE_INVOCATION (ID);

ALTER TABLE DATASET
  ADD CONSTRAINT DATASET_PSI_FK FOREIGN KEY (PIPELINE_STEP_INVOCATION_ID) REFERENCES PIPELINE_STEP_INVOCATION (ID);

GO

UPDATE DATASET
  SET PIPELINE_STEP_INVOCATION_ID = (
		SELECT ID
    FROM PIPELINE_STEP_INVOCATION
    WHERE PIPELINE_STEP_INVOCATION.OUTPUT_DATASET_ID = DATASET.ID
	);

ALTER TABLE PIPELINE_STEP_INVOCATION
  DROP CONSTRAINT PSI_OUT_DATASET_FK;

ALTER TABLE PIPELINE_STEP_INVOCATION
  DROP COLUMN OUTPUT_DATASET_ID;

ALTER TABLE PIPELINE_STEP_INVOCATION
  ADD STATUS VARCHAR(20) DEFAULT NULL;

ALTER TABLE PIPELINE_STEP_INVC_DATASET
  DROP CONSTRAINT PIP_INVC_STEP_DATASET_PK;

ALTER TABLE PIPELINE_STEP_INVC_DATASET
  ALTER COLUMN DATASET_ID BIGINT NULL;

ALTER TABLE PIPELINE_STEP_INVC_DATASET
  ADD INPUT_PIPELINE_STEP_ID BIGINT;

ALTER TABLE PIPELINE_STEP_INVC_DATASET
  ADD CONSTRAINT PSI_INPUT_STEP_PIP_STEP_FK
  FOREIGN KEY (INPUT_PIPELINE_STEP_ID)
  REFERENCES PIPELINE_STEP (ID);

ALTER TABLE PIPELINE_INVOCATION
  ADD SERVICE_REQUEST_ID BIGINT DEFAULT NULL;

ALTER TABLE PIPELINE_INVOCATION
  ADD CONSTRAINT PI_SERVICE_REQUEST_FK FOREIGN KEY (SERVICE_REQUEST_ID) REFERENCES SVC_SERVICE_REQUEST (ID);