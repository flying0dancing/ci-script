{
  "name": "Trades Calculate Value Pipeline",
  "steps": [
    {
      "name": "Union raw trades step",
      "description": "Unions raw trades from internal and external source",
      "type": "UNION",
      "unions": [
        {
          "unionInSchema": {
            "physicalTableName": "TRADES_EXTERNAL",
            "displayName": "Raw Trades Data from another source",
            "version": 1
          },
          "selects": [
            {
              "select": "TDate",
              "outputFieldName": "TRADE_DATE",
              "isWindow": false,
              "window": null
            },
            {
              "select": "S_Date", "outputFieldName": "SETTLEMENT_DATE",
              "isWindow": false,
              "window": null
            },
            {
              "select": "TradeType",
              "outputFieldName": "TradeType",
              "isWindow": false,
              "window": null
            },
            {
              "select": "cast(CONCAT(StockQualifier, StockPart) as long)",
              "outputFieldName": "STOCK_ID",
              "isWindow": false,
              "window": null
            },
            {
              "select": "QUOTE_ID", "outputFieldName": "QUOTE_ID", "isWindow": false,
              "window": null
            },
            {
              "select": "Amount", "outputFieldName": "AMOUNT", "isWindow": false,
              "window": null
            }
          ]
        },
        {
          "unionInSchema": {
            "physicalTableName": "TRADES_INTERNAL",
            "displayName": "Raw Trades Data Internally Sourced",
            "version": 1
          },
          "selects": [
            {
              "select": "TRADE_DATE", "outputFieldName": "TRADE_DATE",
              "isWindow": false,
              "window": null
            },
            {
              "select": "SETTLEMENT_DATE", "outputFieldName": "SETTLEMENT_DATE",
              "isWindow": false,
              "window": null
            },
            {
              "select": "TradeType", "outputFieldName": "TradeType",
              "isWindow": false,
              "window": null
            },
            {
              "select": "STOCK_ID", "outputFieldName": "STOCK_ID",
              "isWindow": false,
              "window": null
            },
            {
              "select": "QUOTE_ID", "outputFieldName": "QUOTE_ID",
              "isWindow": false,
              "window": null
            },
            {
              "select": "AMOUNT", "outputFieldName": "AMOUNT",
              "isWindow": false,
              "window": null
            }
          ]
        }
      ],
      "schemaOut": {
        "physicalTableName": "TRADES_RAW",
        "displayName": "Raw Trades Data with ids and dates",
        "version": 1
      }
    },
    {
      "name": "Join step",
      "description": "Joins Trades Raw to Stocks and Quoted Rates to provide all data for calculation transformation",
      "type": "JOIN",
      "selects": [
        {
          "select": "TRADES_RAW.TRADE_DATE", "outputFieldName": "TRADE_DATE", "isWindow": false,
          "window": null
        },
        {
          "select": "TRADES_RAW.SETTLEMENT_DATE", "outputFieldName": "SETTLEMENT_DATE", "isWindow": false,
          "window": null
        },
        {
          "select": "TRADES_RAW.TradeType", "outputFieldName": "TradeType", "isWindow": false,
          "window": null
        },
        {
          "select": "QUOTES.RATE", "outputFieldName": "RATE", "isWindow": false,
          "window": null
        },
        {
          "select": "TRADES_RAW.AMOUNT", "outputFieldName": "AMOUNT", "isWindow": false,
          "window": null
        },
        {
          "select": "STOCKS.STOCK_NAME", "outputFieldName": "STOCK", "isWindow": false,
          "window": null
        }
      ],
      "schemaOut": {
        "physicalTableName": "TRADES_JOINED",
        "displayName": "Trades Joined from Quotes and Stocks Tables",
        "version": 1
      },
      "joins": [
        {
          "left": {
            "physicalTableName": "TRADES_RAW",
            "displayName": "Raw Trades Data with ids and dates",
            "version": 1
          },
          "right": {
            "physicalTableName": "STOCKS",
            "displayName": "Stock Names",
            "version": 1
          },
          "joinFields": [
            {
              "leftColumn": "STOCK_ID",
              "rightColumn": "STOCK_ID"
            }
          ],
          "type": "LEFT"
        },
        {
          "left": {
            "physicalTableName": "TRADES_RAW",
            "displayName": "Raw Trades Data with ids and dates",
            "version": 1
          },
          "right": {
            "physicalTableName": "QUOTES",
            "displayName": "Stock Quotes",
            "version": 1
          },
          "joinFields": [
            {
              "leftColumn": "QUOTE_ID",
              "rightColumn": "QUOTE_ID"
            }
          ],
          "type": "LEFT"
        }
      ]
    },
    {
      "name": "Map step",
      "description": "Calculate trades value",
      "type": "MAP",
      "selects": [
        {
          "select": "TRADE_DATE", "outputFieldName": "TRADE_DATE",
          "isWindow": false,
          "window": null
        },
        {
          "select": "date_format(from_unixtime(SETTLEMENT_DATE / 1000), 'yyyy-MM-dd')",
          "outputFieldName": "SETTLEMENT_DATE",
          "intermediateResult": true,
          "order" : 1,
          "isWindow": false,
          "window": null
        },
        {
          "select": "workingDaysBetween(get_reference_date(), date(SETTLEMENT_DATE))",
          "outputFieldName": "DAYS_TO_SETTLE_BEFORE_REF_DATE",
          "isWindow": false,
          "window": null
        },
        {
          "select": "TradeType", "outputFieldName": "TradeType",
          "isWindow": false,
          "window": null
        },
        {
          "select": "RATE", "outputFieldName": "RATE",
          "isWindow": false,
          "window": null
        },
        {
          "select": "AMOUNT", "outputFieldName": "AMOUNT",
          "isWindow": false,
          "window": null
        },
        {
          "select": "ROUND((AMOUNT * RATE), 2)", "outputFieldName": "CALCULATED_VALUE",
          "isWindow": false,
          "window": null
        },
        {
          "select": "STOCK", "outputFieldName": "STOCK",
          "isWindow": false,
          "window": null
        }
      ],
      "schemaIn": {
        "physicalTableName": "TRADES_JOINED",
        "displayName": "Trades Joined from Quotes and Stocks Tables",
        "version": 1
      },
      "schemaOut": {
        "physicalTableName": "TRADES_OUT",
        "displayName": "TRADES OUTPUT",
        "version": 1
      }
    },
    {
      "name": "Aggregation step",
      "description": "Calculate total trades by type",
      "type": "AGGREGATION",
      "selects": [
        {
          "select": "TradeType", "outputFieldName": "TradeType", "isWindow": false,
          "window": null
        },
        {
          "select": "COUNT(*)", "outputFieldName": "TOTAL", "isWindow": false,
          "window": null
        }
      ],
      "groupings": [
        "TradeType"
      ],
      "schemaIn": {
        "physicalTableName": "TRADES_JOINED",
        "displayName": "Trades Joined from Quotes and Stocks Tables",
        "version": 1
      },
      "schemaOut": {
        "physicalTableName": "TRADES_AGGREGATED",
        "displayName": "TRADES AGGREGATED",
        "version": 1
      }
    },
    {
      "name": "Window step",
      "description": "Window",
      "type": "WINDOW",
      "selects": [
        {
          "select": "STOCK", "outputFieldName": "STOCK",
          "isWindow": false,
          "window": null
        },
        {
          "select": "TradeType", "outputFieldName": "TradeType",
          "isWindow": false,
          "window": null
        },
        {
          "select": "RATE", "outputFieldName": "RATE",
          "isWindow": false,
          "window": null
        },
        {
          "select": "AMOUNT", "outputFieldName": "AMOUNT",
          "isWindow": false,
          "window": null
        },
        {
          "select": "RANK()", "outputFieldName": "RANK",
          "isWindow": true,
          "window": {
            "partitionBy": ["STOCK", "TradeType"],
            "orderBy": [
              {
                "fieldName": "AMOUNT",
                "direction": "DESC",
                "priority": 0
              }
            ]
          }
        }
      ],
      "schemaIn": {
        "physicalTableName": "TRADES_OUT",
        "displayName": "TRADES OUTPUT",
        "version": 1
      },
      "schemaOut": {
        "physicalTableName": "TRADES_WINDOWED",
        "displayName": "TRADES WINDOWED",
        "version": 1
      }
    },
    {
      "name": "Scriptlet step",
      "description": "Calculate total trades for traders",
      "type": "SCRIPTLET",
      "jarFile": "ignis-spark-script-demo.jar",
      "className": "com.lombardrisk.ignis.spark.script.demo.TotalTradesByTrader",
      "schemasIn": [
        {
          "inputName": "Trades",
          "inputSchema": {
            "physicalTableName": "TRADES_JOINED",
            "displayName": "Trades Joined from Quotes and Stocks Tables",
            "version": 1
          }
        },
        {
          "inputName": "Traders",
          "inputSchema" : {
            "physicalTableName": "TRADERS",
            "displayName": "Traders and trade dates",
            "version": 1
          }
        }
      ],
      "schemaOut": {
        "physicalTableName": "TRADES_BY_TRADER",
        "displayName": "Total trades by trader and stock",
        "version": 1
      }
    }
  ]
}
